# roles/monitoring/templates/alert-rules.yml.j2
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cluster-alerts
  namespace: {{ monitoring_namespace }}
  labels:
    release: prometheus
spec:
  groups:
  - name: cluster
    rules:
    - alert: NodeDown
      expr: up{job="node-exporter"} == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Node {% raw %}{{ $labels.instance }}{% endraw %} is down"

    - alert: HighCPU
      expr: 100 - (avg by(instance)(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High CPU on {% raw %}{{ $labels.instance }}: {{ $value | printf \"%.0f\" }}{% endraw %}%"

    - alert: LowMemory
      expr: (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 < 10
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Low memory on {% raw %}{{ $labels.instance }}{% endraw %}"

    - alert: DiskSpaceLow
      expr: (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes) * 100 < 15
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Low disk on {% raw %}{{ $labels.instance }}: {{ $value | printf \"%.0f\" }}{% endraw %}% free"

    - alert: PodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total[15m]) * 60 * 15 > 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Pod {% raw %}{{ $labels.namespace }}/{{ $labels.pod }}{% endraw %} is crash looping"

    - alert: PodNotReady
      expr: kube_pod_status_ready{condition="false"} == 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pod {% raw %}{{ $labels.namespace }}/{{ $labels.pod }}{% endraw %} is not ready"
