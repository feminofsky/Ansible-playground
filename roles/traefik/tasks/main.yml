# roles/traefik/tasks/main.yml
---
- name: Check if Helm is installed
  command: which helm
  register: helm_check
  failed_when: false
  changed_when: false

- name: Install Helm
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  when: helm_check.rc != 0

- name: Add Traefik Helm repo
  command: helm repo add traefik https://traefik.github.io/charts
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Update Helm repos
  command: helm repo update
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  changed_when: false

- name: Create Traefik namespace
  shell: kubectl create namespace {{ traefik_namespace }} --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

# Cloudflare Authenticated Origin Pulls: secret + TLSOption (must exist before Helm so entrypoint can use it)
- name: Set Cloudflare Origin Pull CA path (role files/)
  set_fact:
    _cf_origin_pull_ca_src: "{{ role_path }}/files/cloudflare-origin-pull-ca.pem"
  when: traefik_cloudflare_origin_pull_enabled | default(false)

- name: Check Cloudflare Origin Pull CA file exists
  stat:
    path: "{{ _cf_origin_pull_ca_src }}"
  register: _cf_ca_file
  when: traefik_cloudflare_origin_pull_enabled | default(false)

- name: Fail when Authenticated Origin Pulls enabled but CA file missing
  fail:
    msg: "traefik_cloudflare_origin_pull_enabled is true but {{ _cf_origin_pull_ca_src }} not found. Download from Cloudflare and put in role files/."
  when:
    - traefik_cloudflare_origin_pull_enabled | default(false)
    - not (_cf_ca_file.stat.exists | default(false))

- name: Copy Cloudflare Origin Pull CA to target and create Secret
  when:
    - traefik_cloudflare_origin_pull_enabled | default(false)
    - _cf_ca_file.stat.exists | default(false)
  block:
    - name: Copy Cloudflare Origin Pull CA to target
      copy:
        src: cloudflare-origin-pull-ca.pem
        dest: /tmp/cloudflare-origin-pull-ca.pem
        mode: '0600'

    - name: Create Secret from Cloudflare Origin Pull CA
      shell: >
        kubectl create secret generic cloudflare-origin-pull-ca
        --from-file=ca.crt=/tmp/cloudflare-origin-pull-ca.pem
        -n {{ traefik_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Remove temp Cloudflare CA file
      file:
        path: /tmp/cloudflare-origin-pull-ca.pem
        state: absent

- name: Apply Cloudflare Origin Pull TLSOption
  when: traefik_cloudflare_origin_pull_enabled | default(false)
  block:
    - name: Template Cloudflare Origin Pull TLSOption
      template:
        src: tlsoption-cloudflare-origin-pull.yml.j2
        dest: /tmp/tlsoption-cloudflare-origin-pull.yml

    - name: Apply Cloudflare Origin Pull TLSOption to cluster
      command: kubectl apply -f /tmp/tlsoption-cloudflare-origin-pull.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Template Traefik values
  template:
    src: traefik-values.yml.j2
    dest: /tmp/traefik-values.yml

- name: Install or upgrade Traefik
  command: >
    helm upgrade --install traefik traefik/traefik
    --namespace {{ traefik_namespace }}
    --values /tmp/traefik-values.yml
    --version {{ traefik_version }}
    --wait
    --timeout {{ traefik_helm_wait_timeout | default('10m') }}
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Wait for Traefik pods to be ready
  command: >
    kubectl wait --namespace {{ traefik_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=traefik
    --timeout=120s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Create namespaces for IngressRoutes (prod, dev, etc.)
  shell: kubectl create namespace {{ item }} --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  loop: "{{ ((subdomains | map(attribute='namespace') | unique | list) + ([monitoring_namespace] if (monitoring_enabled | default(false)) else [])) | unique }}"

- name: Apply security headers middleware
  template:
    src: middleware-security.yml.j2
    dest: /tmp/middleware-security.yml

- name: Apply rate limit middleware
  template:
    src: middleware-ratelimit.yml.j2
    dest: /tmp/middleware-ratelimit.yml

- name: Apply Traefik middlewares
  command: kubectl apply -f /tmp/middleware-{{ item }}.yml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  loop:
    - security
    - ratelimit

- name: Apply VPN allowlist middleware (WireGuard subnet only)
  when: vpn_internal_ui_enabled | default(false)
  block:
    - name: Template VPN allowlist middleware
      template:
        src: middleware-vpn-allowlist.yml.j2
        dest: /tmp/middleware-vpn-allowlist.yml

    - name: Apply VPN allowlist middleware
      command: kubectl apply -f /tmp/middleware-vpn-allowlist.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Remove orphan subdomain IngressRoutes when subdomains is empty
  when: subdomains | length == 0
  block:
    - name: Delete subdomain IngressRoutes from prod
      command: >
        kubectl delete ingressroute {{ item }} -n prod --ignore-not-found
      loop:
        - admin-route
        - api-route
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Delete subdomain IngressRoutes from dev
      command: >
        kubectl delete ingressroute {{ item }} -n dev --ignore-not-found
      loop:
        - dev-route
        - dev-admin-route
        - dev-api-route
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Apply IngressRoutes for all subdomains
  when: subdomains | length > 0
  template:
    src: ingressroute.yml.j2
    dest: /tmp/ingressroute-{{ item.name }}.yml
  loop: "{{ subdomains }}"

- name: Apply IngressRoutes to cluster
  when: subdomains | length > 0
  command: kubectl apply -f /tmp/ingressroute-{{ item.name }}.yml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  loop: "{{ subdomains }}"

- name: Ensure argocd, infisical and bugsink namespaces exist (for VPN IngressRoutes)
  when: vpn_internal_ui_enabled | default(false)
  shell: kubectl create namespace {{ item }} --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  loop: "{{ [argocd_namespace | default('argocd'), infisical_namespace] + ([bugsink_namespace] if (bugsink_enabled | default(false)) else []) }}"

- name: Generate self-signed TLS cert for *.blumefy.local
  when: vpn_internal_ui_enabled | default(false)
  block:
    - name: Create monitoring namespace (for VPN TLS when monitoring enabled)
      when: monitoring_enabled | default(false)
      shell: kubectl create namespace {{ monitoring_namespace }} --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create self-signed cert for VPN internal domain
      command: >
        openssl req -x509 -nodes -days 3650 -newkey rsa:2048
        -keyout /tmp/blumefy-local.key -out /tmp/blumefy-local.crt
        -subj "/CN=*.{{ vpn_internal_domain | default('blumefy.local') }}"
        -addext "subjectAltName=DNS:*.{{ vpn_internal_domain | default('blumefy.local') }},DNS:{{ vpn_internal_domain | default('blumefy.local') }}"

    - name: Create TLS secret for VPN internal (traefik namespace)
      shell: >
        kubectl create secret tls tls-blumefy-local
        --cert=/tmp/blumefy-local.crt --key=/tmp/blumefy-local.key
        -n {{ traefik_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create TLS secret for VPN internal (argocd namespace)
      shell: >
        kubectl create secret tls tls-blumefy-local
        --cert=/tmp/blumefy-local.crt --key=/tmp/blumefy-local.key
        -n {{ argocd_namespace | default('argocd') }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create TLS secret for VPN internal (infisical namespace)
      when: infisical_enabled | default(false)
      shell: >
        kubectl create secret tls tls-blumefy-local
        --cert=/tmp/blumefy-local.crt --key=/tmp/blumefy-local.key
        -n {{ infisical_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create TLS secret for VPN internal (bugsink namespace)
      when: bugsink_enabled | default(false)
      shell: >
        kubectl create secret tls tls-blumefy-local
        --cert=/tmp/blumefy-local.crt --key=/tmp/blumefy-local.key
        -n {{ bugsink_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create TLS secret for VPN internal (monitoring namespace)
      when: monitoring_enabled | default(false)
      shell: >
        kubectl create secret tls tls-blumefy-local
        --cert=/tmp/blumefy-local.crt --key=/tmp/blumefy-local.key
        -n {{ monitoring_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create TLS secret for VPN internal (dev namespace, RabbitMQ)
      when: vpn_internal_ui_enabled | default(false)
      shell: >
        kubectl create secret tls tls-blumefy-local
        --cert=/tmp/blumefy-local.crt --key=/tmp/blumefy-local.key
        -n {{ dev_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create TLS secret for VPN internal (prod namespace, RabbitMQ)
      when: vpn_internal_ui_enabled | default(false)
      shell: >
        kubectl create secret tls tls-blumefy-local
        --cert=/tmp/blumefy-local.crt --key=/tmp/blumefy-local.key
        -n {{ prod_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Remove temp cert files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/blumefy-local.key
        - /tmp/blumefy-local.crt

- name: Deploy internal dashboard (landing page for all VPN apps)
  when: vpn_internal_ui_enabled | default(false)
  block:
    - name: Template internal dashboard HTML
      template:
        src: internal-dashboard-index.html.j2
        dest: /tmp/internal-dashboard-index.html

    - name: Template internal dashboard deployment
      template:
        src: internal-dashboard-deployment.yml.j2
        dest: /tmp/internal-dashboard-deployment.yml

    - name: Template internal dashboard service
      template:
        src: internal-dashboard-service.yml.j2
        dest: /tmp/internal-dashboard-service.yml

    - name: Create internal dashboard ConfigMap from HTML
      shell: >
        kubectl create configmap internal-dashboard-html
        --from-file=index.html=/tmp/internal-dashboard-index.html
        -n {{ traefik_namespace }} --dry-run=client -o yaml
        | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Apply internal dashboard Deployment
      command: kubectl apply -f /tmp/internal-dashboard-deployment.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Apply internal dashboard Service
      command: kubectl apply -f /tmp/internal-dashboard-service.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Apply VPN-only IngressRoutes (dashboard, traefik, argocd, infisical, rabbitmq)
  when: vpn_internal_ui_enabled | default(false)
  block:
    - name: Template legacy RabbitMQ IngressRoutes delete manifest
      template:
        src: ingressroute-vpn-remove-legacy-rabbitmq.yml.j2
        dest: /tmp/ingressroute-vpn-remove-legacy-rabbitmq.yml

    - name: Remove old RabbitMQ IngressRoutes from traefik namespace (moved to dev/prod)
      command: kubectl delete -f /tmp/ingressroute-vpn-remove-legacy-rabbitmq.yml --ignore-not-found=true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: delete_legacy_rabbitmq
      failed_when: false
      changed_when: delete_legacy_rabbitmq.rc == 0 and 'deleted' in delete_legacy_rabbitmq.stdout

    - name: Remove stale monitoring IngressRoutes from monitoring namespace (they now live in traefik namespace)
      shell: >
        kubectl delete ingressroute prometheus-vpn alertmanager-vpn grafana-vpn jaeger-vpn
        -n {{ monitoring_namespace }}
        --ignore-not-found
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: delete_monitoring_ir
      changed_when: "'deleted' in delete_monitoring_ir.stdout or 'No resources found' not in delete_monitoring_ir.stdout"

    - name: Template VPN IngressRoutes
      template:
        src: ingressroute-vpn-internal.yml.j2
        dest: /tmp/ingressroute-vpn-internal.yml

    - name: Apply VPN IngressRoutes to cluster
      command: kubectl apply -f /tmp/ingressroute-vpn-internal.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Get Traefik external IP
  command: >
    kubectl get svc traefik -n {{ traefik_namespace }}
    -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: traefik_ip
  changed_when: false

- name: Show Traefik external IP
  debug:
    msg: "Traefik is available at: {{ traefik_ip.stdout }}"
