# VPN-only IngressRoutes for internal dashboard, Traefik, ArgoCD, Infisical
# Restricted to wireguard_subnet. Uses self-signed TLS (Let's Encrypt doesn't support .local)
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: internal-dashboard-vpn
  namespace: {{ traefik_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`dashboard.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
          namespace: {{ traefik_namespace }}
      services:
        - name: internal-dashboard
          port: 80
          namespace: {{ traefik_namespace }}
  tls:
    secretName: tls-blumefy-local
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard-vpn
  namespace: {{ traefik_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`traefik.{{ vpn_internal_domain | default('blumefy.local') }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))
      kind: Rule
      middlewares:
        - name: vpn-allowlist
          namespace: {{ traefik_namespace }}
      services:
        - name: api@internal
          kind: TraefikService
  tls:
    secretName: tls-blumefy-local
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: argocd-vpn
  namespace: {{ argocd_namespace | default('argocd') }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`argocd.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
      services:
        - name: argocd-server
          port: 80
          namespace: {{ argocd_namespace | default('argocd') }}
  tls:
    secretName: tls-blumefy-local
---
# RabbitMQ Management UI — dev (IngressRoute in dev so Service is same namespace)
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: rabbitmq-dev-vpn
  namespace: {{ dev_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`rabbitmq-dev.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
      services:
        - name: rabbitmq
          port: 15672
  tls:
    secretName: tls-blumefy-local
---
# RabbitMQ Management UI — prod (IngressRoute in prod so Service is same namespace)
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: rabbitmq-prod-vpn
  namespace: {{ prod_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`rabbitmq.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
      services:
        - name: rabbitmq
          port: 15672
  tls:
    secretName: tls-blumefy-local
---
# Redis Commander UI — dev
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: redis-dev-vpn
  namespace: {{ dev_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`redis-dev.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
      services:
        - name: redis-commander
          port: 8081
  tls:
    secretName: tls-blumefy-local
---
# Redis Commander UI — prod
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: redis-prod-vpn
  namespace: {{ prod_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`redis.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
      services:
        - name: redis-commander
          port: 8081
  tls:
    secretName: tls-blumefy-local
{% if infisical_enabled | default(false) %}
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: infisical-vpn
  namespace: {{ infisical_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`infisical.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
      services:
        - name: infisical-infisical-standalone-infisical
          port: 8080
          namespace: {{ infisical_namespace }}
  tls:
    secretName: tls-blumefy-local
{% endif %}
{% if bugsink_enabled | default(false) %}
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: bugsink-vpn
  namespace: {{ traefik_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`bugsink.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
          namespace: {{ traefik_namespace }}
      services:
        - name: bugsink
          port: 8000
          namespace: {{ bugsink_namespace }}
  tls:
    secretName: tls-blumefy-local
{% endif %}
{% if monitoring_enabled | default(false) and vpn_internal_ui_enabled | default(false) %}
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: grafana-vpn
  namespace: {{ monitoring_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`grafana.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
          namespace: {{ traefik_namespace }}
      services:
        - name: prometheus-grafana
          port: 80
          namespace: {{ monitoring_namespace }}
  tls:
    secretName: tls-blumefy-local
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: jaeger-vpn
  namespace: {{ monitoring_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`jaeger.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
          namespace: {{ traefik_namespace }}
      services:
        - name: jaeger-jaeger-query
          port: 16686
          namespace: {{ monitoring_namespace }}
  tls:
    secretName: tls-blumefy-local
{% endif %}
{% if longhorn_enabled | default(false) %}
---
apiVersion: {{ traefik_crd_api_group | default('traefik.io') }}/v1alpha1
kind: IngressRoute
metadata:
  name: longhorn-vpn
  namespace: {{ traefik_namespace }}
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`longhorn.{{ vpn_internal_domain | default('blumefy.local') }}`)
      kind: Rule
      middlewares:
        - name: vpn-allowlist
          namespace: {{ traefik_namespace }}
      services:
        - name: longhorn-frontend
          port: 80
          namespace: longhorn-system
  tls:
    secretName: tls-blumefy-local
{% endif %}
