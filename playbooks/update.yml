# playbooks/update.yml
# Rolling update playbook — zero downtime.
# Order: all control-plane nodes except the init node first, then init node last.
# Uses update_init_node and update_other_nodes from group_vars (inventory-driven).
# Works with 2 nodes (node2 then node1) or 3+ (others then node1).
#
# Usage: ansible-playbook playbooks/update.yml -i inventory/hosts.yml --ask-vault-pass
---
- name: Rolling Update — non-init nodes first
  hosts: "{{ (groups['control_plane'] | difference([groups['control_plane'] | first]) | list) | join(',') }}"
  become: yes
  serial: 1
  vars:
    ansible_port: "{{ ssh_port }}"
    update_init_node: "{{ groups['control_plane'] | first }}"
  tasks:
    - name: Show rolling update order
      debug:
        msg: "Draining and updating {{ inventory_hostname }} (non-init); {{ update_init_node }} will be last."
      run_once: true

    - name: Drain {{ inventory_hostname }}
      command: kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-emptydir-data --timeout=120s
      delegate_to: "{{ update_init_node }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update OS packages
      apt:
        upgrade: dist
        update_cache: yes
        autoremove: yes

    - name: Update K3s
      shell: curl -sfL https://get.k3s.io | sh -
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        K3S_TOKEN: "{{ k3s_token }}"

    - name: Restart K3s
      systemd:
        name: k3s
        state: restarted

    - name: Wait for {{ inventory_hostname }} to be Ready
      command: kubectl wait node/{{ inventory_hostname }} --for=condition=Ready --timeout=120s
      delegate_to: "{{ update_init_node }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Uncordon {{ inventory_hostname }}
      command: kubectl uncordon {{ inventory_hostname }}
      delegate_to: "{{ update_init_node }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait 60s before next node
      pause:
        seconds: 60

- name: Rolling Update — init node (last)
  hosts: "{{ groups['control_plane'] | first }}"
  become: yes
  vars:
    ansible_port: "{{ ssh_port }}"
  tasks:
    - name: Drain {{ inventory_hostname }}
      command: kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-emptydir-data --timeout=120s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update OS packages
      apt:
        upgrade: dist
        update_cache: yes
        autoremove: yes

    - name: Update K3s
      shell: curl -sfL https://get.k3s.io | sh -
      environment:
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        K3S_TOKEN: "{{ k3s_token }}"

    - name: Restart K3s
      systemd:
        name: k3s
        state: restarted

    - name: Wait for {{ inventory_hostname }} to be Ready
      command: kubectl wait node/{{ inventory_hostname }} --for=condition=Ready --timeout=120s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Uncordon {{ inventory_hostname }}
      command: kubectl uncordon {{ inventory_hostname }}
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Verify cluster after update
  hosts: "{{ groups['control_plane'] | first }}"
  become: yes
  vars:
    ansible_port: "{{ ssh_port }}"
  tasks:
    - name: Show cluster status
      command: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: result

    - debug:
        var: result.stdout_lines
