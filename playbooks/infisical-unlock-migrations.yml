# playbooks/infisical-unlock-migrations.yml
# Clears stale knex migration lock so Infisical can boot
# Run when you see: "Migration table is already locked"
#
# Usage: ansible-playbook playbooks/infisical-unlock-migrations.yml -i inventory/hosts.yml
#
# If the job fails (wrong secret/service/db), override:
#   -e infisical_postgres_secret=RELEASE-postgresql
#   -e infisical_postgres_service=RELEASE-postgresql
#   -e infisical_postgres_database=infisicalDB
#   -e infisical_postgres_password_key=postgres-password  # if Bitnami uses that key
---
- name: Unlock Infisical migration table
  hosts: control_plane
  become: yes
  gather_facts: false
  run_once: true
  vars:
    pg_secret: "{{ infisical_postgres_secret | default('postgresql') }}"
    pg_service: "{{ infisical_postgres_service | default('postgresql') }}"
    pg_database: "{{ infisical_postgres_database | default('infisicalDB') }}"
    # postgres user needs postgres-password; app user uses password
    pg_password_key: "{{ infisical_postgres_password_key | default('postgres-password') }}"
  tasks:
    - name: Delete any existing migrate-unlock job (clean slate)
      command: kubectl delete job infisical-migrate-unlock -n {{ infisical_namespace }} --ignore-not-found=true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: true

    - name: Discover PostgreSQL secret and service names
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        NS="{{ infisical_namespace }}"
        # Find postgres secret (short name 'postgresql' or Helm prefixed)
        for s in postgresql infisical-postgresql infisical-infisical-standalone-postgresql; do
          kubectl get secret "$s" -n "$NS" &>/dev/null && echo "secret=$s" && break
        done
        # Find postgres service
        for s in postgresql infisical-postgresql infisical-infisical-standalone-postgresql; do
          kubectl get svc "$s" -n "$NS" &>/dev/null && echo "service=$s" && break
        done
        # Get password key from secret (Bitnami uses 'password' or 'postgres-password')
        SECRET=$(kubectl get secrets -n "$NS" -o name 2>/dev/null | grep -i postgres | head -1 | cut -d/ -f2)
        if [ -n "$SECRET" ]; then
          for k in postgres-password password postgresql-password; do
            kubectl get secret "$SECRET" -n "$NS" -o jsonpath="{.data.$k}" &>/dev/null && echo "key=$k" && break
          done
        fi
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: discover
      changed_when: false
      failed_when: false

    - name: Apply discovered PostgreSQL connection
      set_fact:
        pg_secret: "{{ discover.stdout_lines | select('search', 'secret=') | first | regex_replace('secret=', '') | default(pg_secret) }}"
        pg_service: "{{ discover.stdout_lines | select('search', 'service=') | first | regex_replace('service=', '') | default(pg_service) }}"
        pg_password_key: "{{ discover.stdout_lines | select('search', 'key=') | first | regex_replace('key=', '') | default(pg_password_key) }}"
      when: discover.stdout | length > 0

    - name: Show PostgreSQL connection
      debug:
        msg: "secret={{ pg_secret }}, key={{ pg_password_key }}, service={{ pg_service }}"

    - name: Create migration unlock job manifest
      template:
        src: infisical-unlock-job.yml.j2
        dest: /tmp/infisical-unlock-job.yml

    - name: Run migration unlock job
      command: kubectl apply -f /tmp/infisical-unlock-job.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait for unlock job to complete
      command: >
        kubectl wait job/infisical-migrate-unlock -n {{ infisical_namespace }}
        --for=condition=complete --timeout=60s
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Delete unlock job
      command: kubectl delete job infisical-migrate-unlock -n {{ infisical_namespace }} --ignore-not-found=true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Restart Infisical pod to retry migrations
      command: >
        kubectl delete pod -n {{ infisical_namespace }}
        -l component=infisical --ignore-not-found=true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: true

    - name: Cleanup temp manifest
      file:
        path: /tmp/infisical-unlock-job.yml
        state: absent

    - name: Unlock complete
      debug:
        msg: |
          Migration lock released. Infisical pod is restarting.
          Check status: kubectl get pods -n {{ infisical_namespace }} -l component=infisical
          Logs: kubectl logs -n {{ infisical_namespace }} -l component=infisical -f
