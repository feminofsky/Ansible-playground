---
{{- range $name, $app := .Values.app }}
{{- if hasKey $app "test-enabled" }}
{{- with $ -}}
apiVersion: v1
kind: Pod
metadata:
  name: {{ $name }}-test
  annotations:
    sidecar.istio.io/inject: "false"
    helm.sh/hook: "test-success"
    # helm.sh/hook-delete-policy: "hook-succeeded"
spec:
  {{- with .Values.imagePullSecrets }}
  imagePullSecrets:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  containers:
    - name: {{ $name }}-test
      image: {{ .Values.test.image }}:{{ .Values.test.imageTag }}
      imagePullPolicy: {{ .Values.test.imagePullPolicy }}
      command: ["/bin/sh", "-e", "-c"]
      args:
        - |
          {{ $app.test  | nindent 12 }}
  restartPolicy: Never
---
{{- end }}
{{- end }}
{{- end }}
